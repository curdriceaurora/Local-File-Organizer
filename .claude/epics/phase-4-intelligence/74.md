---
name: fix-cleanup-offset-calculation
title: Fix OFFSET calculation edge cases in operation history cleanup
status: open
created: 2026-01-21T09:18:28Z
updated: 2026-01-21T09:22:45Z
size: S
hours: 4
parallel: false
dependencies: []
---

# Issue #74: Fix OFFSET calculation edge cases

## Description

The OFFSET calculation for max_operations cleanup needs adjustment to handle edge cases correctly.

## Current Problem

- Off-by-one errors possible when total_ops == max_operations
- Edge case: What if max_operations is 0?
- Edge case: What if operations are added during cleanup?
- No transaction safety around count + delete
- OFFSET might miss operations if new ones arrive

## Proposed Solution

1. Add explicit edge case handling
2. Use transaction to ensure atomic count + delete
3. Add tests for edge cases

## Acceptance Criteria

- [ ] Edge cases handled (zero, negative, equal)
- [ ] Transaction safety implemented
- [ ] Tests for boundary conditions
- [ ] Documentation on max_operations behavior
- [ ] Concurrent cleanup safety verified

## Technical Details

**File**: `src/file_organizer/history/cleanup.py` (lines 141-156)
**Priority**: Low-Medium
**Risk**: Data integrity

## References

- CodeRabbit PR #67 review comment
