---
name: task-008-undo-redo-functionality
title: Build undo/redo functionality
epic: phase-4-intelligence
github_issue: null
status: open
size: L
hours: 24
parallel: false
depends_on: [53]
created: 2026-01-21T05:53:08Z
updated: 2026-01-26T00:52:32Z
assignee: null
labels: [task, phase-4, undo-redo, user-feature]
github: https://github.com/curdriceaurora/Local-File-Organizer/issues/224
---

# Task 008: Build undo/redo functionality

**Epic:** Phase 4 - Intelligence & Learning
**Size:** Large (24 hours)
**Can run in parallel:** No
**Dependencies:** Task 007 (Operation history tracking)

## Objective
Implement a reliable undo/redo system that allows users to safely revert file organization operations, including both single and batch operations.

## Requirements

### 1. Undo Operations
- **Single operation undo**: Revert the last file operation
- **Batch operation undo**: Revert entire transaction atomically
- **Selective undo**: Undo specific operation by ID
- **Cascading undo**: Undo multiple operations in reverse order
- **Validation before undo**: Check if undo is possible
- **Conflict detection**: Handle cases where files have changed

### 2. Redo Operations
- **Single operation redo**: Re-apply undone operation
- **Batch operation redo**: Re-apply undone transaction
- **Redo stack management**: Track undone operations
- **Clear redo on new operation**: Invalidate redo stack appropriately

### 3. Operation History Viewer
- **List recent operations**: Show last N operations
- **Filter by type**: Move, rename, delete, copy
- **Filter by date**: Show operations in date range
- **Filter by transaction**: Show batch operations
- **Search by path**: Find operations affecting specific files
- **Display metadata**: Show file details, timestamps, status

### 4. Safe Rollback
- **Validation checks**:
  - Target paths exist/don't exist as expected
  - Source paths still available (for redo)
  - File integrity verification (hash comparison)
  - Sufficient disk space
  - Proper permissions
- **Atomic rollback**: All or nothing for transactions
- **Error handling**: Graceful failure with detailed messages
- **Partial rollback support**: Handle failures mid-transaction

### 5. Edge Case Handling
- **File conflicts**: Handle files modified after operation
- **Missing files**: Detect and report missing source/destination
- **Permission errors**: Handle insufficient permissions
- **Disk space**: Handle out-of-space scenarios
- **Concurrent modifications**: Detect external changes
- **Path changes**: Handle renamed parent directories

## Technical Approach

### Python Implementation Structure
```python
# file_organizer_v2/src/file_organizer/undo/
├── undo_manager.py       # Main undo/redo logic
├── validator.py          # Pre-undo validation
├── rollback.py           # Rollback execution
├── viewer.py             # History viewer UI
└── models.py             # Undo/redo data models
```

### Key Classes
```python
class UndoManager:
    """Main interface for undo/redo operations"""
    def undo_last_operation() -> bool
    def undo_transaction(transaction_id) -> bool
    def undo_operation(operation_id) -> bool
    def redo_last_operation() -> bool
    def redo_operation(operation_id) -> bool
    def can_undo(operation_id) -> tuple[bool, str]
    def can_redo(operation_id) -> tuple[bool, str]
    def get_undo_stack() -> List[Operation]
    def get_redo_stack() -> List[Operation]
    def clear_redo_stack()

class OperationValidator:
    """Validates operations before undo/redo"""
    def validate_undo(operation) -> ValidationResult
    def validate_redo(operation) -> ValidationResult
    def check_file_integrity(path, expected_hash) -> bool
    def check_path_availability(path) -> bool
    def check_conflicts(operation) -> List[Conflict]

class RollbackExecutor:
    """Executes rollback operations"""
    def rollback_move(operation) -> bool
    def rollback_rename(operation) -> bool
    def rollback_delete(operation) -> bool
    def rollback_copy(operation) -> bool
    def rollback_transaction(transaction_id) -> RollbackResult

class HistoryViewer:
    """CLI/UI for viewing operation history"""
    def show_recent_operations(limit=10)
    def show_transaction_details(transaction_id)
    def show_operation_details(operation_id)
    def filter_operations(filters) -> List[Operation]
    def search_by_path(path) -> List[Operation]

class ValidationResult:
    can_proceed: bool
    conflicts: List[Conflict]
    warnings: List[str]
    error_message: Optional[str]

class RollbackResult:
    success: bool
    operations_rolled_back: int
    operations_failed: int
    errors: List[tuple[operation_id, error_message]]
```

### Undo Logic by Operation Type

#### Move Operation Undo
```python
# Original: source_path -> destination_path
# Undo: destination_path -> source_path
def undo_move(operation):
    1. Validate destination still exists
    2. Check source location is available
    3. Move file back to source
    4. Update operation status to 'rolled_back'
    5. Clear redo stack
```

#### Rename Operation Undo
```python
# Original: old_name -> new_name
# Undo: new_name -> old_name
def undo_rename(operation):
    1. Validate new_name still exists
    2. Check old_name is available
    3. Rename back to old_name
    4. Update operation status
```

#### Delete Operation Undo
```python
# Original: file deleted (moved to trash)
# Undo: restore from trash
def undo_delete(operation):
    1. Check trash location for file
    2. Validate destination is available
    3. Restore file from trash
    4. Verify file integrity (hash)
    5. Update operation status
```

#### Copy Operation Undo
```python
# Original: created copy at destination
# Undo: delete the copy
def undo_copy(operation):
    1. Validate destination copy exists
    2. Verify it's the same file (hash)
    3. Delete the copy
    4. Update operation status
```

## Implementation Steps

1. **Undo Manager Core** (6 hours)
   - Implement UndoManager class
   - Add undo_last_operation method
   - Add undo_operation method
   - Add undo_transaction method
   - Test basic undo functionality

2. **Redo Manager** (4 hours)
   - Implement redo stack management
   - Add redo_last_operation method
   - Add redo_operation method
   - Test redo functionality
   - Test undo/redo interaction

3. **Operation Validator** (5 hours)
   - Implement validation logic
   - Add file integrity checks
   - Add conflict detection
   - Add path availability checks
   - Test all validation scenarios

4. **Rollback Executor** (5 hours)
   - Implement rollback for move operations
   - Implement rollback for rename operations
   - Implement rollback for delete operations
   - Implement rollback for copy operations
   - Test each rollback type

5. **History Viewer** (3 hours)
   - Implement CLI viewer
   - Add filtering capabilities
   - Add search functionality
   - Format output nicely
   - Test viewer features

6. **Integration & Testing** (1 hour)
   - Integrate with main application
   - End-to-end testing
   - Documentation
   - User guide

## Acceptance Criteria

- [ ] Undo single operation works correctly
- [ ] Undo batch operation works atomically
- [ ] Redo operations work correctly
- [ ] Validation prevents unsafe undo operations
- [ ] Conflicts are detected and reported
- [ ] History viewer shows recent operations
- [ ] Filter and search work correctly
- [ ] All edge cases handled gracefully
- [ ] File integrity verified before/after undo
- [ ] Redo stack cleared on new operations
- [ ] Transaction rollback is atomic (all or nothing)
- [ ] Performance: Undo 100 operations in < 5 seconds
- [ ] Unit tests cover >90% of code
- [ ] Documentation complete with examples

## Testing Strategy

### Unit Tests
- Undo move operation
- Undo rename operation
- Undo delete operation
- Undo copy operation
- Redo operations
- Validation logic
- Conflict detection
- Stack management

### Integration Tests
- Undo after file organization
- Batch operation undo
- Redo after undo
- Validation with real files
- Concurrent modification detection

### Edge Case Tests
- File conflict during undo
- Missing file during undo
- Permission error during undo
- Disk space error during undo
- Parent directory renamed
- External file modification
- Partial transaction rollback

### User Acceptance Tests
- User undoes accidental organization
- User reviews history before undo
- User handles undo conflict
- User redoes undone operation

## CLI Interface

```bash
# Undo last operation
file-organizer undo

# Undo specific operation
file-organizer undo --operation-id 12345

# Undo transaction
file-organizer undo --transaction-id abc-123

# Redo last undone operation
file-organizer redo

# View history
file-organizer history --limit 20

# View history with filter
file-organizer history --type move --since "2026-01-01"

# Search history
file-organizer history --search "/path/to/file"

# View transaction details
file-organizer history --transaction abc-123
```

## Files to Create/Modify

### New Files
- `file_organizer_v2/src/file_organizer/undo/__init__.py`
- `file_organizer_v2/src/file_organizer/undo/undo_manager.py`
- `file_organizer_v2/src/file_organizer/undo/validator.py`
- `file_organizer_v2/src/file_organizer/undo/rollback.py`
- `file_organizer_v2/src/file_organizer/undo/viewer.py`
- `file_organizer_v2/src/file_organizer/undo/models.py`
- `file_organizer_v2/tests/undo/test_undo_manager.py`
- `file_organizer_v2/tests/undo/test_validator.py`
- `file_organizer_v2/tests/undo/test_rollback.py`
- `file_organizer_v2/tests/undo/test_viewer.py`

### Modified Files
- `file_organizer_v2/demo.py` (add undo/redo/history commands)
- `file_organizer_v2/src/file_organizer/core/organizer.py` (integrate undo)
- `file_organizer_v2/README.md` (document undo/redo features)

## Dependencies
- Task 007 (Operation history tracking) must be complete
- Standard Python libraries: pathlib, shutil, hashlib

## Risks & Mitigations

**Risk:** Undo creates new conflicts
**Mitigation:** Comprehensive validation before undo, clear error messages

**Risk:** File integrity compromised
**Mitigation:** Hash verification, refuse undo if file changed

**Risk:** Partial rollback failure
**Mitigation:** Transaction support, detailed error reporting, recovery procedures

**Risk:** User confusion about undo/redo state
**Mitigation:** Clear UI, history viewer, confirmation prompts for batch operations

**Risk:** Performance with large undo stacks
**Mitigation:** Limit undo history, optimize queries, lazy loading

## Notes
- Delete operations move files to trash (not permanent delete)
- Trash location: `~/.file_organizer/trash/`
- Trash retention: 30 days default
- Undo operations are logged in history
- Redo stack is cleared on new operations
- Consider confirmation prompt for batch undo
- Provide dry-run mode to preview undo effects

## Related Tasks
- Task 007: Design and implement operation history tracking (prerequisite)

## References
- Git undo/redo mechanisms for inspiration
- File system transaction patterns
- Command pattern for undo/redo design
